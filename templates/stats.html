{% extends 'base.html' %}

{% block title %}Statistika · TG Yuk statistika{% endblock %}

{% block content %}
<h2 class="text-xl md:text-2xl font-semibold mb-3">Kanal statistika</h2>
<p class="subtitle text-sm md:text-base text-slate-600 mb-4">Kanal ID: <span class="pill inline-flex items-center rounded-full border border-slate-300 px-2 py-0.5 text-[11px] uppercase tracking-wide text-slate-500">{{ channel_id }}</span> · Jami yuk eʼlonlari: <strong>{{ total_shipments }}</strong></p>

{% now "Y-m-d" as today %}
<form method="get" class="mt-3 flex flex-wrap items-end gap-3">
  <div class="flex flex-col">
    <label class="text-xs md:text-sm text-slate-600 mb-1">Boshlanish sanasi</label>
    <input type="date" name="date_from" value="{{ date_from }}"
           class="rounded-md border border-slate-300 bg-white px-4 py-2.5 text-sm md:text-base text-slate-800 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 min-w-[220px] md:min-w-[260px]">
  </div>
  <div class="flex flex-col">
    <label class="text-xs md:text-sm text-slate-600 mb-1">Tugash sanasi</label>
    <input type="date" name="date_to" value="{{ date_to }}"
           class="rounded-md border border-slate-300 bg-white px-4 py-2.5 text-sm md:text-base text-slate-800 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 min-w-[220px] md:min-w-[260px]">
  </div>
  <div class="flex flex-wrap gap-2 mt-3 md:mt-0">
    <button type="submit"
            class="inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm md:text-base font-semibold text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1">
      Filtrlash
    </button>
    <a href="?date_from={{ today }}&date_to={{ today }}"
       class="inline-flex items-center rounded-md bg-emerald-500 px-4 py-2 text-sm md:text-base font-semibold text-white shadow-sm hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-1">
      Bugungi yuklar
    </a>
    <a href="{% url 'channel_stats_excel' channel_id %}?date_from={{ date_from }}&date_to={{ date_to }}"
       class="inline-flex items-center rounded-md bg-amber-500 px-4 py-2 text-sm md:text-base font-semibold text-white shadow-sm hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-1">
      Excel yuklab olish
    </a>
    <a href="{% url 'channel_phones' channel_id %}?date_from={{ date_from }}&date_to={{ date_to }}"
       class="inline-flex items-center rounded-md bg-purple-500 px-4 py-2 text-sm md:text-base font-semibold text-white shadow-sm hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-1">
      Telefonlar (unikal)
    </a>
  </div>
</form>

<div class="mt-4 grid grid-cols-1 lg:grid-cols-[1.4fr_1fr] gap-4">
  <section>
    <h3>A → B yo'nalishlari</h3>
    <table class="mt-3 w-full text-sm md:text-base">
      <thead>
      <tr>
        <th>Qayerdan</th>
        <th>Qayerga</th>
        <th>Soni</th>
      </tr>
      </thead>
      <tbody>
      {% for r in route_stats %}
      <tr>
        <td>{{ r.origin|default:'-' }}</td>
        <td>{{ r.destination|default:'-' }}</td>
        <td>
          <a href="{% url 'channel_route_messages' channel_id %}?origin={{ r.origin }}&destination={{ r.destination }}&date_from={{ date_from }}&date_to={{ date_to }}">
            {{ r.total }}
          </a>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="3">Yo‘nalishlar topilmadi.</td></tr>
      {% endfor %}
      </tbody>
    </table>

    {% if route_page_obj and route_page_obj.paginator.num_pages > 1 %}
    <div class="mt-2 flex items-center justify-center gap-3 text-xs md:text-sm text-slate-700">
      {% if route_page_obj.has_previous %}
        <a href="?route_page={{ route_page_obj.previous_page_number }}&date_from={{ date_from }}&date_to={{ date_to }}"
           class="inline-flex items-center rounded-full border border-slate-300 bg-white px-3 py-1 font-medium hover:bg-slate-100">⬅ Oldingi</a>
      {% endif %}
      <span class="px-3 py-1 rounded-full bg-slate-100 border border-slate-200">Sahifa {{ route_page_obj.number }} / {{ route_page_obj.paginator.num_pages }}</span>
      {% if route_page_obj.has_next %}
        <a href="?route_page={{ route_page_obj.next_page_number }}&date_from={{ date_from }}&date_to={{ date_to }}"
           class="inline-flex items-center rounded-full border border-slate-300 bg-white px-3 py-1 font-medium hover:bg-slate-100">Keyingi ➡</a>
      {% endif %}
    </div>
    {% endif %}

    {% if route_page_obj %}
    <div class="mt-3 flex items-center gap-3 text-sm text-slate-700">
      {% if route_page_obj.has_previous %}
        <a href="?route_page={{ route_page_obj.previous_page_number }}&date_from={{ date_from }}&date_to={{ date_to }}"
           class="inline-flex items-center rounded-md bg-slate-100 px-3 py-1 font-medium hover:bg-slate-200">⬅ Oldingi</a>
      {% endif %}

      <span>Sahifa {{ route_page_obj.number }} / {{ route_page_obj.paginator.num_pages }}</span>

      {% if route_page_obj.has_next %}
        <a href="?route_page={{ route_page_obj.next_page_number }}&date_from={{ date_from }}&date_to={{ date_to }}"
           class="inline-flex items-center rounded-md bg-slate-100 px-3 py-1 font-medium hover:bg-slate-200">Keyingi ➡</a>
      {% endif %}
    </div>
    {% endif %}
  </section>

  <section>
    <h3 class="text-sm md:text-base font-semibold text-slate-800 mb-2">Yuk turlari</h3>
    <table class="mt-3 w-full text-sm md:text-base">
      <thead class="bg-blue-50">
      <tr>
        <th>Yuk</th>
        <th>Soni</th>
      </tr>
      </thead>
      <tbody>
      {% for c in cargo_stats %}
      <tr>
        <td>{{ c.cargo_type|default:'-' }}</td>
        <td>
          <a href="{% url 'channel_cargo_messages' channel_id %}?cargo_type={{ c.cargo_type }}&date_from={{ date_from }}&date_to={{ date_to }}">
            {{ c.total }}
          </a>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="2">Yuk turlari topilmadi.</td></tr>
      {% endfor %}
      </tbody>
    </table>

    {% if cargo_page_obj and cargo_page_obj.paginator.num_pages > 1 %}
    <div class="mt-2 flex items-center justify-center gap-3 text-xs md:text-sm text-slate-700">
      {% if cargo_page_obj.has_previous %}
        <a href="?cargo_page={{ cargo_page_obj.previous_page_number }}&date_from={{ date_from }}&date_to={{ date_to }}"
           class="inline-flex items-center rounded-full border border-slate-300 bg-white px-3 py-1 font-medium hover:bg-slate-100">⬅ Oldingi</a>
      {% endif %}
      <span class="px-3 py-1 rounded-full bg-slate-100 border border-slate-200">Sahifa {{ cargo_page_obj.number }} / {{ cargo_page_obj.paginator.num_pages }}</span>
      {% if cargo_page_obj.has_next %}
        <a href="?cargo_page={{ cargo_page_obj.next_page_number }}&date_from={{ date_from }}&date_to={{ date_to }}"
           class="inline-flex items-center rounded-full border border-slate-300 bg-white px-3 py-1 font-medium hover:bg-slate-100">Keyingi ➡</a>
      {% endif %}
    </div>
    {% endif %}

    <h3 class="mt-3">Transport (ТЕНТ va boshqalar)</h3>
    <table class="mt-3 w-full text-sm md:text-base">
      <thead>
      <tr>
        <th>Transport</th>
        <th>Soni</th>
      </tr>
      </thead>
      <tbody>
      {% for t in truck_stats %}
      <tr>
        <td>{{ t.truck_type|default:'-' }}</td>
        <td>
          <a href="{% url 'channel_truck_messages' channel_id %}?truck_type={{ t.truck_type }}&date_from={{ date_from }}&date_to={{ date_to }}">
            {{ t.total }}
          </a>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="2">Transport turlari topilmadi.</td></tr>
      {% endfor %}
      </tbody>
    </table>

    {% if truck_page_obj and truck_page_obj.paginator.num_pages > 1 %}
    <div class="mt-2 flex items-center justify-center gap-3 text-xs md:text-sm text-slate-700">
      {% if truck_page_obj.has_previous %}
        <a href="?truck_page={{ truck_page_obj.previous_page_number }}&date_from={{ date_from }}&date_to={{ date_to }}"
           class="inline-flex items-center rounded-full border border-slate-300 bg-white px-3 py-1 font-medium hover:bg-slate-100">⬅ Oldingi</a>
      {% endif %}
      <span class="px-3 py-1 rounded-full bg-slate-100 border border-slate-200">Sahifa {{ truck_page_obj.number }} / {{ truck_page_obj.paginator.num_pages }}</span>
      {% if truck_page_obj.has_next %}
        <a href="?truck_page={{ truck_page_obj.next_page_number }}&date_from={{ date_from }}&date_to={{ date_to }}"
           class="inline-flex items-center rounded-full border border-slate-300 bg-white px-3 py-1 font-medium hover:bg-slate-100">Keyingi ➡</a>
      {% endif %}
    </div>
    {% endif %}
  </section>
</div>

<h3 class="mt-6 text-sm md:text-base font-semibold text-slate-800 mb-2">To'lov turi</h3>
<table class="mt-3 w-full text-sm md:text-base">
  <thead class="bg-emerald-50">
  <tr>
    <th>To'lov</th>
    <th>Soni</th>
  </tr>
  </thead>
  <tbody>
  {% for p in payment_stats %}
  <tr>
    <td>{{ p.payment_type|default:'-' }}</td>
    <td>
      <a href="{% url 'channel_payment_messages' channel_id %}?payment_type={{ p.payment_type }}&date_from={{ date_from }}&date_to={{ date_to }}">
        {{ p.total }}
      </a>
    </td>
  </tr>
  {% empty %}
  <tr><td colspan="2">To'lov maʼlumotlari topilmadi.</td></tr>
  {% endfor %}
  </tbody>
</table>

{% if payment_page_obj and payment_page_obj.paginator.num_pages > 1 %}
<div class="mt-2 flex items-center justify-center gap-3 text-xs md:text-sm text-slate-700">
  {% if payment_page_obj.has_previous %}
    <a href="?payment_page={{ payment_page_obj.previous_page_number }}&date_from={{ date_from }}&date_to={{ date_to }}"
       class="inline-flex items-center rounded-full border border-slate-300 bg-white px-3 py-1 font-medium hover:bg-slate-100">⬅ Oldingi</a>
  {% endif %}
  <span class="px-3 py-1 rounded-full bg-slate-100 border border-slate-200">Sahifa {{ payment_page_obj.number }} / {{ payment_page_obj.paginator.num_pages }}</span>
  {% if payment_page_obj.has_next %}
    <a href="?payment_page={{ payment_page_obj.next_page_number }}&date_from={{ date_from }}&date_to={{ date_to }}"
       class="inline-flex items-center rounded-full border border-slate-300 bg-white px-3 py-1 font-medium hover:bg-slate-100">Keyingi ➡</a>
  {% endif %}
</div>
{% endif %}

<div class="mt-4 flex flex-wrap gap-3">
  <a class="inline-flex items-center rounded-md bg-slate-100 px-4 py-2 text-sm md:text-base font-medium text-slate-800 hover:bg-slate-200" href="/channels/">⬅ Kanallarga qaytish</a>
  <a class="inline-flex items-center rounded-md bg-slate-100 px-4 py-2 text-sm md:text-base font-medium text-slate-800 hover:bg-slate-200" href="/messages/">Xabarlar ro‘yxatini ko‘rish</a>
</div>
{% endblock %}
